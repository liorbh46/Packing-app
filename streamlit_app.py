import os
import streamlit as st
from groq import Groq

# =========================
#   ×”×’×“×¨×•×ª ×¢××•×“
# =========================
st.set_page_config(
    page_title="PackBot AI",
    page_icon="ğŸ§³",
    layout="centered"
)

# =========================
#   ×¢×™×¦×•×‘ ××•×ª×× ××•×‘×™×™×œ + RTL
# =========================
st.markdown("""
<style>
    html, body, [class*="css"] {
        direction: rtl;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    [data-testid="stAppViewContainer"] > .main {
        max-width: 480px;
        margin: 0 auto;
        padding: 0.75rem 0.75rem 2.75rem 0.75rem;
    }

    .stChatMessage {
        direction: rtl;
        text-align: right;
    }

    .stChatInput {
        direction: rtl;
    }

    div[data-testid="stMarkdownContainer"] {
        text-align: right;
    }

    h1 {
        text-align: center;
        font-size: 1.6rem;
        margin-bottom: 0.1rem;
    }

    .sub-caption {
        text-align: center;
        font-size: 0.85rem;
        color: #6b7280;
        margin-bottom: 0.8rem;
    }

    [data-testid="stSidebar"] {
        min-width: 220px;
        max-width: 260px;
    }
</style>
""", unsafe_allow_html=True)

st.title("PackBot AI ğŸ§³")
st.markdown(
    '<div class="sub-caption">×¦×³××˜ ×—×›× ×œ×‘× ×™×™×ª ×¨×©×™××ª ×¦×™×•×“ ××•×ª×××ª ××™×©×™×ª</div>',
    unsafe_allow_html=True
)

# =========================
#   ××¤×ª×— Groq (×—×™× ×)
# =========================
# ×¢×“×™×¤×•×ª: ××¤×ª×— ×‘-Secrets ×‘×©× GROQ_API_KEY
api_key_env = os.getenv("GROQ_API_KEY", "")
api_key = api_key_env

with st.sidebar:
    st.markdown("### ğŸ”‘ ××¤×ª×— Groq")
    if api_key_env:
        # ×× ×”××¤×ª×— ×›×‘×¨ ×‘-Secrets â€“ ×¨×§ ×”×•×“×¢×” ×§×˜× ×”, ×‘×œ×™ ×©×“×” ×§×œ×˜
        st.success("×”××¤×ª×— × ×˜×¢×Ÿ ××•×˜×•××˜×™×ª ×-Secrets. ×”×›×œ ××•×›×Ÿ âœ…")
    else:
        # ×¨×§ ×× ××™×Ÿ ××¤×ª×— ×‘-Secrets â€“ ××‘×§×©×™× ××—×“ ×™×“× ×™×ª
        st.caption("××•××œ×¥ ×œ×©××•×¨ ××ª ×”××¤×ª×— ×‘-Secrets ×‘×©× GROQ_API_KEY.")
        manual_key = st.text_input("×”×“×‘×§ ×›××Ÿ ××¤×ª×— Groq:", type="password")
        if manual_key.strip():
            api_key = manual_key.strip()

if not api_key:
    st.error(
        "×œ× × ××¦× GROQ_API_KEY.\n\n"
        "×‘-Streamlit Cloud: ×”×™×›× ×¡ ×œ-Settings â†’ Secrets ×•×”×•×¡×£ ×©×•×¨×”:\n"
        'GROQ_API_KEY = "gsk_XXXXXXXXXXXX"\n\n'
        "××ª ×”××¤×ª×— ×™×•×¦×¨×™× ×‘×—×©×‘×•×Ÿ ×”×—×™× ××™ ×‘-console.groq.com."
    )
    st.stop()

client = Groq(api_key=api_key)

# =========================
#   × ×™×”×•×œ ×–×™×›×¨×•×Ÿ ×”×©×™×—×”
# =========================
if "messages" not in st.session_state:
    st.session_state.messages = [
        {
            "role": "assistant",
            "content": "×”×™×™, ×× ×™ PackBot â€“ ××•××—×” ×”××¨×™×–×” ×©×œ×š. ×¡×¤×¨ ×œ×™ ×‘×§×¦×¨×” ×œ××Ÿ ××ª×” × ×•×¡×¢ ×•××ª×™?"
        }
    ]

# =========================
#   ×¤×•× ×§×¦×™×” ×©×©×•××œ×ª ××ª Groq
# =========================
def ask_groq():
    """
    ×©×œ×‘ 1 â€“ ×¨××™×•×Ÿ: ×©××œ×” ××—×ª ×‘×›×œ ×¤×¢×.
    ×©×œ×‘ 2 â€“ ×¨×©×™××ª ×¦×™×•×“ ×‘×¤×•×¨××˜ ×˜×§×¡×˜ ×œ×”×“×‘×§×” ×‘×¤×ª×§×™×.
    """

    system_prompt = (
        "××ª×” PackBot, ××¨××™×™×Ÿ ××¨×™×–×” ×—×›×.\n"
        "×”××˜×¨×” ×©×œ×š: ×œ× ×”×œ ×¨××™×•×Ÿ ×§×¦×¨ ××—×“-×¢×œ-××—×“ ×¢×œ ×”× ×¡×™×¢×” ×©×œ ×”××©×ª××©, "
        "×•×œ×‘×¡×•×£ ×œ×‘× ×•×ª ×œ×• ×¨×©×™××ª ×¦×™×•×“ ×‘×¤×•×¨××˜ ×˜×§×¡×˜ ×¤×©×•×˜ ×©××¤×©×¨ ×œ×”×“×‘×™×§ ×™×©×™×¨×•×ª ×‘×¤×ª×§×™× ×‘××™×™×¤×•×Ÿ.\n\n"

        "×©×œ×‘ 1 â€“ ×¨××™×•×Ÿ:\n"
        "â€¢ ××ª×” ×©×•××œ ×ª××™×“ ×©××œ×” ××—×ª ×‘×œ×‘×“ ×‘×›×œ ×”×•×“×¢×” ×©×œ×š.\n"
        "â€¢ ××œ ×ª×©××œ ×©×ª×™ ×©××œ×•×ª ×‘××•×ª×” ×”×•×“×¢×” ×•××œ ×ª×©×ª××© ×‘×™×•×ª×¨ ××¡×™××Ÿ ×©××œ×” ××—×“.\n"
        "â€¢ ×›×œ ×ª×©×•×‘×” ×©×œ×š ×‘×©×œ×‘ ×”×¨××™×•×Ÿ ×¦×¨×™×›×” ×œ×”×™×•×ª ×§×¦×¨×”: ××©×¤×˜ ××—×“ ×©××¨××” ×©×”×‘× ×ª + ×©××œ×” ××—×ª ×‘×¨×•×¨×”.\n"
        "â€¢ ×ª×ª××§×“ ×‘×©××œ×•×ª ×¢×œ: ×™×¢×“ ×”× ×¡×™×¢×”, ×ª××¨×™×›×™×, ××©×š, ××™ × ×•×¡×¢, ×¡×•×’ ×”×—×•×¤×©×”, ××–×’ ×”××•×•×™×¨ ×”××©×•×¢×¨, "
        "×¡×•×’ ×”××–×•×•×“×”/×ª×™×§, ×”×× ××ª×•×›× × ×ª ×›×‘×™×¡×”, ×•×¤×¢×™×œ×•×™×•×ª ××™×•×—×“×•×ª.\n"
        "â€¢ ×‘×©×œ×‘ ×–×” ××œ ×ª×™×ª×Ÿ ×¢×“×™×™×Ÿ ×¨×©×™××•×ª ×¦×™×•×“ â€“ ×¨×§ ×©××œ×•×ª, ×”×‘×”×¨×•×ª ×•×§×¦×ª ×”×›×•×•× ×”.\n\n"

        "×©×œ×‘ 2 â€“ ×¨×©×™××ª ×¦×™×•×“ ×œ×”×“×‘×§×” ×‘×¤×ª×§×™×:\n"
        "×›××©×¨ ×™×© ×œ×š ××¡×¤×™×§ ××™×“×¢ ×›×“×™ ×œ×‘× ×•×ª ×¨×©×™××ª ×¦×™×•×“ ×˜×•×‘×”, ××ª×” ××¤×¡×™×§ ×œ×©××•×œ ×©××œ×•×ª "
        "×•× ×•×ª×Ÿ ×œ××©×ª××© ××š ×•×¨×§ ×˜×§×¡×˜ ×‘×¤×•×¨××˜ ×”×‘× (×—×©×•×‘ ×œ×”×§×¤×™×“):\n\n"
        "1. ×©×•×¨×” ×¨××©×•× ×”: ×›×•×ª×¨×ª, ×œ××©×œ '×¨×©×™××ª ×¦×™×•×“ × ×¡×™×¢×” ×œ<×™×¢×“>' ××• '×¨×©×™××ª ×¦×™×•×“ ×©×”×™×™×”'.\n"
        "2. ×©×•×¨×” ×©× ×™×™×”: ×¨×™×§×”.\n"
        "3. ××—×¨×™ ×–×”: ×›×œ ×¤×¨×™×˜ ×‘×©×•×¨×” × ×¤×¨×“×ª, ×‘×œ×™ ××¡×¤×¨×™×, ×‘×œ×™ × ×§×•×“×•×ª ×•×‘×œ×™ ××§×¤×™×.\n\n"
        "×“×•×’××” ×¨×§ ×œ×¤×•×¨××˜ (×œ× ×œ×ª×•×›×Ÿ ×‘×¤×•×¢×œ):\n"
        "×¨×©×™××ª ×¦×™×•×“ ×©×”×™×™×”\n"
        "\n"
        "××–×•×•×“×” ×’×“×•×œ×”\n"
        "××’×‘×ª\n"
        "×§×¨× ×”×’× ×”\n"
        "×’×³×™× ×¡×™×\n"
        "×‘×’×“×™× ×œ×œ×™×œ×”\n"
        "×ª×—×ª×•× ×™×\n"
        "×’×¨×‘×™×™×\n"
        "××©×§×¤×™ ×©××©\n"
        "××¨× ×§\n"
        "×“×¨×›×•×Ÿ\n\n"
        "×”× ×—×™×•×ª ×§×¨×™×˜×™×•×ª ×œ×©×œ×‘ ×”×¨×©×™××”:\n"
        "â€¢ ××œ ×ª×›×ª×•×‘ ×©×•× ×˜×§×¡×˜ ×œ×¤× ×™ ××• ××—×¨×™ ×”×¨×©×™××” â€“ ×¨×§ ×”×›×•×ª×¨×ª, ×©×•×¨×” ×¨×™×§×” ×•×”×¤×¨×™×˜×™×.\n"
        "â€¢ ××œ ×ª×•×¡×™×£ ×××•×’×³×™, ×”×¡×‘×¨×™×, ×¡×•×’×¨×™×™× ××• ×”×¢×¨×•×ª.\n"
        "â€¢ ×¨×©×•× ×¨×§ ×¤×¨×™×˜×™× ×¨×œ×•×•× ×˜×™×™× ×œ× ×¡×™×¢×” ×”×¡×¤×¦×™×¤×™×ª ×©×œ ×”××©×ª××©.\n"
        "â€¢ ××—×¨×™ ×©× ×ª×ª ××ª ×”×¨×©×™××” ×”×¡×•×¤×™×ª, ××œ ×ª×©××œ ×¢×•×“ ×©××œ×•×ª ××™×•×–××ª×š. "
        "×× ×”××©×ª××© ×™×‘×§×© ×©×™× ×•×™/×”×•×¡×¤×” â€“ ×ª×¢× ×”, ××‘×œ ×©××•×¨ ×¢×œ ××•×ª×• ×¤×•×¨××˜ ×˜×§×¡×˜ ×¤×©×•×˜.\n"
        "â€¢ ×ª××™×“ ×“×‘×¨ ×‘×¢×‘×¨×™×ª.\n"
    )

    messages = [{"role": "system", "content": system_prompt}]
    messages.extend(st.session_state.messages)

    try:
        completion = client.chat.completions.create(
            model="llama-3.1-8b-instant",
            messages=messages,
            temperature=0.6,
        )
        return completion.choices[0].message.content

    except Exception as e:
        return f"×©×’×™××” ×‘×©×™×—×” ×¢× Groq: {str(e)}"

# =========================
#   ×”×¦×’×ª ×”×™×¡×˜×•×¨×™×™×ª ×”×©×™×—×”
# =========================
for msg in st.session_state.messages:
    st.chat_message(msg["role"]).write(msg["content"])

# =========================
#   ×§×œ×˜ ××”××©×ª××©
# =========================
user_input = st.chat_input("×›×ª×•×‘ ×›××Ÿ ××ª ×”×ª×©×•×‘×” / ×”×©××œ×” ×”×‘××” ×©×œ×š...")

if user_input:
    st.chat_message("user").write(user_input)
    st.session_state.messages.append({"role": "user", "content": user_input})

    with st.spinner("××•×¨×– ××—×©×‘×•×ª..."):
        ai_response = ask_groq()

    st.chat_message("assistant").write(ai_response)
    st.session_state.messages.append({"role": "assistant", "content": ai_response})